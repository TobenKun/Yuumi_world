---
{"dg-publish":true,"permalink":"/CODING/C언어/010.1 작동 방식이 궁금해/","noteIcon":"2"}
---

루프를 돌아야 하는 게임 특성상 루프를 돌기 전과 루프 이렇게 두 섹션으로 나눠볼 수 있다.

## 루프 돌기 전(사전 준비)
우리는 인자로 들어온 맵 파일을 토대로 게임 구조체를 초기화 해야한다.

### 맵 읽어오기
- 인자가 하나만 들어왔는지 확인
- 인자로 받아온 맵 파일의 경로가 .cub로 끝나는지 확인
- 맵 파일을 열 수 있는지 체크 (권한이 없거나 잘못된 경로)
- 한 줄씩 읽으면서 구조체에 야무지게 읽어온 값을 저장
	- 각 벽의 텍스쳐, 바닥과 천장 색상
	- 맵은 다 이어 붙인 뒤에 올바른 값으로 들어왔는지 체크함
	- 이때 이상한 글자 들어오거나 하는거 체크

### 게임 세팅
- 파싱 받아온 내용을 토대로 게임 구조체에 값을 저장
- mlx 와 mlx_win를 사전에 정한 값으로 초기화
- 윈도우에 직접 뿌릴 이미지와 기타 이미지를 만들고 읽어오기
	- 각 벽의 텍스쳐도 읽어온다 -> 텍스쳐 파일이 없거나 권한이 없는 경우는 내부에서 예외 처리
- 플레이어 구조체도 맵 내용에 따라 초기화 한다.
	- 맵 안에서 플레이어의 위치는 어디였는지, 초기 방향은 어디였는지

### 키 훅 설정
- 꾹 누르고 있을 때 부드럽게 이동할 수 있게 키를 누르는 시점과 키를 떼는 시점을 구분함
- w, a, s, d는 키를 눌렀을 때 true가 될  수 있도록 하여 release 되는 시점까지 루프에서 해당 동작이 반복되도록 설정
- mandatory의 경우 좌우 화살표로 시점을 옮길 수 있어야 하기 때문에 이부분 역시 키훅에 등록해놓음

## 루프 내부(게임 실행 중)
- 매 호출 마다 플레이어의 움직임을 반영하고, 그에 따른 화면의 렌더링을 계산하고 화면에 출력함

### 플레이어 움직임
- 현재 어떤 키가 눌려져있는지에 따라 해당 방향의 벽 충돌 여부를 확인한 다음 진행
	- define으로 조금 보기 편하게 수정함

### 렌더링
- 플레이어의 시야인 60도를 1920번 쪼개서 벽과의 거리를 측정함
	- 해당 시점의 플레이어가 보는 방향을 기준으로 왼쪽 30도 오른쪽 30도
- 세로줄 하나 당 벽까지의 거리를 재고, 거리에 따라 가까우면 작게, 멀면 길게 그리는걸 1920번 반복

#### 벽까지 거리를 구하는 함수
- 현재 각도로 연장선을 그리면서 거리를 측정
- 가로 벽과 세로벽까지의 충돌 거리를 구하고 그 중에 가까운 것을 최종 거리로 저장
- 지금 충돌한 벽이 가로 벽인지 세로 벽인지와 현재 각도를 알면 내가 동서남북 중 벽의 어떤 면을 보고 있는지 알 수 있음 -> 어떤 텍스쳐를 그릴지 정하는데 필요

#### 거리에 맞춰 벽을 그리는 함수
- 게임 시작전에 로드 해놓은 벽 텍스쳐 중 지금 필요한 텍스쳐를 가져옴
- set_info에서 내가 보는 벽의 종류, 거리에 따라 벽의 어떤 부분을 어떤 비율로 가져올지를 설정
- 위에서부터 세로로 그리기 시작
	- 천장, 벽, 바닥 순으로
	- 천장과 바닥은 색상이 정해져 있는 반면 벽은 텍스쳐에 따라 달라짐
	- 텍스쳐에서 특정 위치의 컬러를 가져와서 해당 색상으로 픽셀을 찍는다
- 플레이어가 보는 방향의 벽을 모두 이미지에 그렸다면 마지막으로 이미지를 윈도우에 올림
- 일련의 과정을 게임 종료시까지 반복